# 更新系统使用演示

## 📋 已创建的文件

✅ **核心文件**
- `version.txt` - 当前版本号 (v1.10.0)
- `update.bat` - Windows 自动更新脚本
- `update.sh` - Linux/Mac 自动更新脚本
- `utils/update_checker.py` - 启动时自动检查更新

✅ **文档文件**
- `README.md` - 已添加更新说明章节
- `CHANGELOG.md` - 已记录 v1.10.0 版本变更
- `.cursorrules` - 已添加版本发布流程
- `更新说明.md` - 详细的更新指南

✅ **代码修改**
- `__init__.py` - 已集成启动时更新检查

---

## 🎬 使用演示

### 场景 1：用户首次更新（Windows）

1. **用户操作**：
   - 进入插件目录
   - 双击 `update.bat`

2. **脚本执行过程**：
   ```
   ====================================
   Comfyui_o1key 插件更新工具
   ====================================

   当前版本: v1.9.1

   [1/4] 检查远程更新...
   发现新版本！

   [2/4] 备份配置文件...
   已备份 .config 到 .config.backup

   [3/4] 拉取最新代码...
   Updating files: 100%
   
   [4/4] 更新依赖包...
   Successfully installed aiohttp-3.9.1

   ====================================
   更新完成！
   ====================================
   新版本: v1.10.0

   最近更新内容:
   -----------------------------------
   ## [1.10.0] - 2026-02-06
   
   ### Added ⭐
   - 自动更新系统
   ...
   -----------------------------------

   请重启 ComfyUI 以使更改生效

   请按任意键继续...
   ```

3. **结果**：
   - ✅ 代码已更新到最新版本
   - ✅ 配置文件已自动恢复
   - ✅ 依赖包已更新
   - ✅ 用户看到更新日志

---

### 场景 2：用户首次更新（Linux/Mac）

1. **用户操作**：
   ```bash
   cd ComfyUI/custom_nodes/Comfyui_o1key
   chmod +x update.sh
   ./update.sh
   ```

2. **脚本执行过程**（带颜色）：
   ```
   ====================================
   Comfyui_o1key 插件更新工具
   ====================================

   当前版本: v1.9.1

   [1/4] 检查远程更新...
   发现新版本！  (绿色)

   [2/4] 备份配置文件...
   已备份 .config 到 .config.backup

   [3/4] 拉取最新代码...
   代码更新成功  (绿色)

   [4/4] 更新依赖包...
   依赖包更新成功  (绿色)

   ====================================
   更新完成！  (绿色)
   ====================================
   新版本: v1.10.0

   最近更新内容:
   -----------------------------------
   (显示 CHANGELOG 前 20 行)
   -----------------------------------

   请重启 ComfyUI 以使更改生效
   ```

3. **结果**：同上

---

### 场景 3：已是最新版本

1. **用户操作**：运行更新脚本

2. **脚本输出**：
   ```
   ====================================
   Comfyui_o1key 插件更新工具
   ====================================

   当前版本: v1.10.0

   [1/4] 检查远程更新...
   已是最新版本

   是否继续检查依赖更新？(y/n)
   ```

3. **用户选择**：
   - 输入 `y`: 继续检查并更新依赖包
   - 输入 `n`: 直接退出

---

### 场景 4：启动时自动检查更新

1. **用户操作**：
   - 正常启动 ComfyUI

2. **终端输出**（如有新版本）：
   ```
   [ComfyUI 正常启动信息...]
   
   ============================================================
   🎉 Comfyui_o1key 有新版本可用 (当前版本: v1.10.0)
   ============================================================
   更新方法：
     Windows: 双击运行 update.bat
     Linux/Mac: 运行 ./update.sh
   或手动执行: git pull origin main
   ============================================================

   [ComfyUI 继续启动...]
   ```

3. **特点**：
   - 不影响 ComfyUI 启动速度
   - 不阻塞启动流程
   - 信息清晰醒目
   - 提供明确的更新指引

---

### 场景 5：更新失败处理

1. **网络错误**：
   ```
   [3/4] 拉取最新代码...
   [错误] 代码更新失败，请检查网络连接或手动解决冲突
   
   请按任意键继续...
   ```

2. **依赖更新失败**：
   ```
   [4/4] 更新依赖包...
   [警告] 依赖包更新失败，请手动运行: pip install -r requirements.txt
   ```

3. **不是 Git 仓库**：
   ```
   [错误] 当前目录不是 Git 仓库
   请确保插件是通过 git clone 安装的
   ```

---

## 🔄 开发者发布新版本流程

### 步骤 1：开发和测试

```bash
# 正常开发...
git add .
git commit -m "feat: 添加新功能"
```

### 步骤 2：准备发布

1. 更新 `version.txt`：
   ```bash
   echo "v1.11.0" > version.txt
   ```

2. 更新 `CHANGELOG.md`：
   ```markdown
   ## [1.11.0] - 2026-02-07
   
   ### Added
   - 新增某某功能
   ```

3. 更新 `README.md`（如需要）

### 步骤 3：提交和发布

```bash
# 提交版本变更
git add version.txt CHANGELOG.md README.md
git commit -m "Release v1.11.0: 新功能描述"

# 创建标签
git tag v1.11.0

# 推送到远程（带标签）
git push origin main --tags
```

### 步骤 4：用户自动获取

用户只需运行更新脚本即可：
- Windows: 双击 `update.bat`
- Linux/Mac: 运行 `./update.sh`

---

## ✨ 优势对比

### 传统方式（手动更新）

❌ 用户需要记住多条命令  
❌ 可能忘记更新依赖包  
❌ 配置文件可能被覆盖  
❌ 不知道是否有新版本  
❌ 更新后不知道改了什么  

### 自动更新系统

✅ 一键操作，简单快捷  
✅ 自动处理所有步骤  
✅ 配置文件自动备份恢复  
✅ 启动时自动检查更新  
✅ 显示详细的更新日志  
✅ 友好的中文提示  
✅ 完善的错误处理  

---

## 🎯 技术实现细节

### 更新检查原理

```python
# 比较本地和远程 Git 提交
local_commit = git rev-parse @
remote_commit = git rev-parse @{u}

if local_commit != remote_commit:
    # 有新版本
    notify_user()
```

### 配置文件保护

```bash
# 更新前备份
cp .config .config.backup

# 拉取代码
git pull origin main

# 更新后恢复
mv .config.backup .config
```

### 异步检查设计

```python
# 在 __init__.py 中
try:
    if check_for_updates():  # 最多 10 秒超时
        notify_update_available()
except Exception:
    pass  # 静默失败，不影响启动
```

---

## 📊 预期效果

### 用户体验提升

- **简化操作**：从"记住多条命令"到"双击一个文件"
- **减少错误**：自动处理所有更新步骤，避免人为失误
- **提高更新率**：降低更新门槛，更多用户及时获取新功能
- **增强信任**：专业的更新体验提升插件整体质量感

### 开发者收益

- **快速反馈**：用户能及时更新，快速验证新功能
- **减少支持**：自动化减少"如何更新"的咨询
- **版本追踪**：清晰的版本号管理
- **规范流程**：标准化的发布流程

---

**🎉 享受自动更新带来的便利！**
